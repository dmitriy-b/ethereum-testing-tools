name: Run gas benchmarks

on:
  workflow_dispatch:
    inputs:
      runs:
        description: Number of benchmark runs
        required: false
        default: '1'
      testPath:
        description: Path to test files
        required: false
        default: 'eest_tests'
      genesisFile:
        description: Genesis file to use
        required: false
        default: 'zkevmgenesis.json'
      warmupFile:
        description: Warmup file path
        required: false
        default: 'warmup/warmup-1000bl-16wi-24tx.txt'
      clients:
        description: Comma-separated list of clients to test
        required: false
        default: 'nethermind'
      filter:
        description: Test filter pattern
        required: false
        default: ''
      postgresHost:
        description: PostgreSQL host
        required: false
        default: ''
      postgresPort:
        description: PostgreSQL port
        required: false
        default: '5432'
      postgresDbName:
        description: PostgreSQL database name
        required: false
        default: 'monitoring'
      postgresTable:
        description: PostgreSQL table name
        required: false
        default: 'gas_benchmarks_ci'

jobs:
  gas-benchmarks:
    runs-on: ubuntu-latest # default runner; override to change VM

    steps:
      - name: Checkout gas-benchmarks repository
        uses: actions/checkout@v4
        with:
          repository: NethermindEth/gas-benchmarks
          ref: feat/gas-benchmark-workflow  # <--- IMPORTANT: Specify the branch/tag you want!
          lfs: true                         # <--- Keeps LFS files correct

      - name: Run gas-benchmarks composite action
        uses: ./.github/actions/gas-benchmark-action  # <--- CHANGED: Use local path
        with:
          # Benchmark configuration (all optional, with sensible defaults)
          testPath: ${{ github.event.inputs.testPath }}
          genesisFile: ${{ github.event.inputs.genesisFile }}
          warmupFile: ${{ github.event.inputs.warmupFile }}
          clients: ${{ github.event.inputs.clients }}
          runs: ${{ github.event.inputs.runs }}
          opcodeWarmupCount: '1'
          filter: ${{ github.event.inputs.filter }}
          images: '{"nethermind":"default","geth":"default","reth":"default","erigon":"default","besu":"default","nimbus":"default","ethrex":"default"}'

          # PostgreSQL target (no DB is provisioned by this workflow)
          postgresHost: ${{ github.event.inputs.postgresHost }}
          postgresPort: ${{ github.event.inputs.postgresPort }}
          postgresDbName: ${{ github.event.inputs.postgresDbName }}
          postgresTable: ${{ github.event.inputs.postgresTable }}

          # DB credentials passed from your repository secrets
          postgresUser: ${{ secrets.PERFNET_DB_USER }}
          postgresPassword: ${{ secrets.PERFNET_DB_PASSWORD }}
